# MFDP - Medical Flow Data Platform
## Комплексная документация проекта

## Содержание
1. [Обзор проекта](#обзор-проекта)
2. [Архитектура системы](#архитектура-системы)
3. [Логика работы программного обеспечения](#логика-работы-программного-обеспечения)
4. [Модули системы](#модули-системы)
5. [Инструкция по работе с фронтендом](#инструкция-по-работе-с-фронтендом)
6. [Инструкция по работе с API](#инструкция-по-работе-с-api)
7. [Развертывание и запуск](#развертывание-и-запуск)
8. [Мониторинг и отладка](#мониторинг-и-отладка)

## Обзор проекта

MFDP (Medical Flow Data Platform) - комплексная система для управления медицинскими процессами с использованием машинного обучения. Система предназначена для прогнозирования неявок пациентов, оптимизации загрузки врачей и адаптивного планирования в реальном времени.

### Основные возможности:
- **Прогнозирование неявок пациентов** - ML-модель для оценки вероятности неявки
- **Динамическая оптимизация загрузки врачей** - балансировка расписания и ресурсов
- **Адаптивное планирование реального времени** - автоматическая корректировка расписания
- **Аналитика и отчетность** - визуализация данных и метрик
- **Управление пользователями и событиями** - административные функции

### Технологический стек:
- **Backend**: FastAPI, SQLAlchemy, PostgreSQL
- **Frontend**: HTML/CSS/JavaScript, Chart.js
- **ML**: scikit-learn, pandas, numpy, XGBoost
- **Infrastructure**: Docker, Redis, RabbitMQ, Nginx
- **Monitoring**: Prometheus, Grafana

## Архитектура системы

### Общая архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   API Gateway   │    │   ML Workers    │
│   (Interface)   │◄──►│   (FastAPI)     │◄──►│   (Celery)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   PostgreSQL    │◄──►│   Services      │◄──►│   Redis Cache   │
│   (Database)    │    │   (Business)    │    │   (Caching)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Слои архитектуры

#### 1. Presentation Layer (Frontend)
- **Файлы**: `interface/`
- **Технологии**: HTML, CSS, JavaScript
- **Компоненты**: Дашборды, формы, графики

#### 2. API Layer (Backend)
- **Файлы**: `app/api.py`, `app/routes/`
- **Технологии**: FastAPI, Pydantic
- **Функции**: REST API, валидация, документация

#### 3. Business Logic Layer
- **Файлы**: `app/services/`
- **Технологии**: Python, ML библиотеки
- **Функции**: Бизнес-логика, ML модели, алгоритмы

#### 4. Data Access Layer
- **Файлы**: `app/repositories/`, `app/models/`
- **Технологии**: SQLAlchemy, PostgreSQL
- **Функции**: Работа с данными, ORM

#### 5. Infrastructure Layer
- **Файлы**: `docker-compose.yaml`, `nginx/`
- **Технологии**: Docker, Redis, RabbitMQ
- **Функции**: Контейнеризация, кэширование, очереди

## Логика работы программного обеспечения

### Основной поток данных

1. **Получение запроса**
   - Frontend отправляет HTTP запрос к API
   - Nginx проксирует запрос к FastAPI приложению
   - Middleware обрабатывает CORS и аутентификацию

2. **Обработка запроса**
   - FastAPI роутер направляет запрос к соответствующему обработчику
   - Pydantic валидирует входящие данные
   - Сервисный слой выполняет бизнес-логику

3. **Работа с данными**
   - Repository слой взаимодействует с базой данных
   - Кэширование через Redis для часто запрашиваемых данных
   - Асинхронная обработка через RabbitMQ для тяжелых задач

4. **Возврат результата**
   - Форматирование ответа через Pydantic модели
   - Логирование операций
   - Отправка ответа клиенту

### ML Pipeline

1. **Подготовка данных**
   - Загрузка данных из PostgreSQL
   - Предобработка и feature engineering
   - Разделение на train/test наборы

2. **Обучение модели**
   - Выбор алгоритма (RandomForest, XGBoost)
   - Гиперпараметрическая оптимизация через Optuna
   - Валидация и оценка качества

3. **Прогнозирование**
   - Загрузка обученной модели
   - Предобработка входных данных
   - Выполнение прогноза

4. **Постобработка**
   - Интерпретация результатов
   - Генерация рекомендаций
   - Сохранение результатов

## Модули системы

### 1. Модуль прогнозирования неявок пациентов

#### Компоненты:
- **NoShowPredictionService** - основной сервис прогнозирования
- **PatientHistoryAnalyzer** - анализ истории пациента
- **AppointmentPredictor** - ML модель прогнозирования
- **NotificationManager** - управление уведомлениями

#### API Endpoints:
```
POST /api/no-show-prediction/predict
GET /api/no-show-prediction/statistics
GET /api/no-show-prediction/high-risk-patients
POST /api/no-show-prediction/train
```

#### Логика работы:
1. Получение данных пациента (возраст, тип приема, история)
2. Feature engineering и предобработка
3. Прогнозирование вероятности неявки
4. Определение уровня риска и рекомендаций
5. Сохранение результата и отправка уведомлений

### 2. Модуль динамической оптимизации загрузки врачей

#### Компоненты:
- **LoadBalancer** - алгоритмы балансировки нагрузки
- **ScheduleOptimizer** - оптимизация расписания
- **ResourceAllocator** - распределение ресурсов
- **PerformanceTracker** - отслеживание производительности

#### API Endpoints:
```
POST /api/doctor-load-optimization/optimize-schedule
GET /api/doctor-load-optimization/doctor-metrics
GET /api/doctor-load-optimization/load-balance
GET /api/doctor-load-optimization/performance-report/{doctor_id}
```

#### Логика работы:
1. Анализ текущей загрузки врачей
2. Определение целей оптимизации
3. Применение алгоритмов оптимизации
4. Генерация рекомендаций
5. Обновление расписания

### 3. Модуль адаптивного планирования реального времени

#### Компоненты:
- **RealTimeScheduler** - основной планировщик
- **AdaptiveOptimizer** - адаптивная оптимизация
- **EventProcessor** - обработка событий
- **DynamicAdjuster** - динамическая корректировка

#### API Endpoints:
```
POST /api/real-time-scheduler/event
GET /api/real-time-scheduler/health
```

#### Логика работы:
1. Мониторинг событий в реальном времени
2. Анализ конфликтов и нарушений
3. Генерация альтернативных решений
4. Автоматическая корректировка расписания
5. Уведомление заинтересованных сторон

## Инструкция по работе с фронтендом

### Структура интерфейса

```
interface/
├── index.html              # Основная страница
├── app.js                  # Основная логика
├── api-service.js          # API клиент
├── components.js           # Компоненты модулей
├── style.css              # Стили
└── test_integration.html   # Тестовая страница
```

### Навигация

1. **Главная панель** - общая статистика и метрики
2. **Аналитика** - детальная аналитика и графики
3. **События** - управление медицинскими событиями
4. **ML Операции** - мониторинг ML моделей
5. **Прогноз неявок** - работа с модулем прогнозирования
6. **Оптимизация врачей** - управление загрузкой врачей
7. **Адаптивное планирование** - обработка событий в реальном времени
8. **Расписание** - управление расписанием
9. **Пользователи** - административные функции

### Работа с модулем прогнозирования неявок

1. **Переход в раздел**: Нажмите "Прогноз неявок" в навигации
2. **Ввод данных пациента**:
   - Возраст пациента
   - Тип приема (консультация, обследование, процедура, операция)
   - Специальность врача
   - Время приема
   - Количество предыдущих неявок
   - Расстояние до клиники
3. **Получение прогноза**: Нажмите "Получить прогноз"
4. **Анализ результатов**:
   - Вероятность неявки (в процентах)
   - Уровень риска (низкий/средний/высокий)
   - Рекомендации по снижению риска

### Работа с модулем оптимизации врачей

1. **Переход в раздел**: Нажмите "Оптимизация врачей" в навигации
2. **Настройка параметров**:
   - Дата оптимизации
   - Цель оптимизации (балансировка нагрузки, минимизация времени ожидания, максимизация использования)
   - Фильтр по специальности (опционально)
3. **Запуск оптимизации**: Нажмите "Запустить оптимизацию"
4. **Анализ результатов**:
   - Коэффициент эффективности
   - Сокращение времени ожидания
   - Улучшение использования ресурсов
   - Список рекомендаций

### Работа с модулем адаптивного планирования

1. **Переход в раздел**: Нажмите "Адаптивное планирование" в навигации
2. **Обработка события**:
   - Выбор типа события (отмена записи, задержка врача, экстренный случай)
   - Ввод ID записи
   - Указание даты события
   - Для задержки - указание времени задержки
3. **Отправка события**: Нажмите "Обработать событие"
4. **Анализ результатов**:
   - Тип обработанного события
   - Количество найденных конфликтов
   - Количество предложенных альтернатив
   - Эффективность обработки

### Функции дашборда

1. **Метрики**: Отображение ключевых показателей
2. **Графики**: Интерактивные графики с Chart.js
3. **Таблицы**: Сортировка и фильтрация данных
4. **Уведомления**: Система уведомлений об ошибках и успешных операциях

## Инструкция по работе с API

### Базовый URL
```
http://localhost:8080/api
```

### Аутентификация

Большинство endpoints требуют JWT токен в заголовке:
```bash
Authorization: Bearer <your-jwt-token>
```

### Основные endpoints

#### Health Check
```bash
GET /health
```

#### Аутентификация
```bash
POST /auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin"
}
```

#### Прогнозирование неявок

**Получение прогноза:**
```bash
POST /api/no-show-prediction/predict
Content-Type: application/json

{
  "age": 35,
  "appointment_type": "consultation",
  "speciality": "терапевт",
  "appointment_time": "2025-06-25T10:00:00",
  "previous_no_shows": 1,
  "distance_to_clinic": 5.2
}
```

**Статистика модели:**
```bash
GET /api/no-show-prediction/statistics
```

**Пациенты высокого риска:**
```bash
GET /api/no-show-prediction/high-risk-patients
```

#### Оптимизация врачей

**Запуск оптимизации:**
```bash
POST /api/doctor-load-optimization/optimize-schedule
Content-Type: application/json

{
  "date": "2025-06-25",
  "objective": "balance_load",
  "speciality": "терапевт"
}
```

**Метрики врачей:**
```bash
GET /api/doctor-load-optimization/doctor-metrics
```

**Анализ баланса нагрузки:**
```bash
GET /api/doctor-load-optimization/load-balance
```

#### Адаптивное планирование

**Обработка события:**
```bash
POST /api/real-time-scheduler/event
Content-Type: application/json

{
  "event_type": "delay",
  "event_data": {
    "appointment_id": 123,
    "date": "2025-06-25T10:00:00",
    "delay_minutes": 15
  }
}
```

**Состояние сервиса:**
```bash
GET /api/real-time-scheduler/health
```

### Обработка ошибок

API возвращает стандартные HTTP коды:
- `200` - успешный запрос
- `400` - ошибка валидации
- `401` - неавторизованный доступ
- `404` - ресурс не найден
- `500` - внутренняя ошибка сервера

Пример ответа с ошибкой:
```json
{
  "detail": "Ошибка валидации данных",
  "status_code": 400
}
```

### Пагинация

Для endpoints, возвращающих списки:
```bash
GET /api/events?page=1&size=10
```

### Фильтрация и сортировка

```bash
GET /api/events?status=active&sort_by=date&sort_order=desc
```

## Развертывание и запуск

### Требования к системе

- Docker и Docker Compose
- Минимум 4GB RAM
- 10GB свободного места на диске
- Порты 80, 8080, 5432, 15673, 5673

### Быстрый запуск через Docker

1. **Клонирование репозитория:**
```bash
git clone <repository-url>
cd MFDP_main
```

2. **Создание файла .env:**
```bash
# PostgreSQL
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=medical_db

# RabbitMQ
RABBITMQ_USER=admin
RABBITMQ_PASS=admin123

# JWT
SECRET_KEY=your-secret-key-here

# Режим разработки (без БД)
DEVELOPMENT_MODE=false
```

3. **Запуск системы:**
```bash
docker-compose up -d
```

4. **Проверка статуса:**
```bash
docker-compose ps
```

### Проверка работоспособности

1. **API Health Check:**
```bash
curl http://localhost:8080/health
```

2. **Веб-интерфейс:**
```
http://localhost:80
```

3. **API документация:**
```
http://localhost:8080/api/docs
```

4. **RabbitMQ Management:**
```
http://localhost:15673
```

### Локальная разработка

1. **Установка зависимостей:**
```bash
cd app
pip install -r requirements.txt
```

2. **Настройка базы данных:**
```bash
# Создание .env файла
cp .env.example .env
# Редактирование настроек БД
```

3. **Инициализация БД:**
```bash
python database/initdb.py
```

4. **Запуск приложения:**
```bash
python api.py
```

### Проблемы и решения

#### Проблемы с портами
```bash
# Поиск процессов на порту
lsof -i :8080
# Остановка процесса
kill -9 <PID>
```

#### Проблемы с базой данных
```bash
# Пересоздание БД
docker-compose down
docker volume rm mfdp_main_postgres_data
docker-compose up -d
```

#### Проблемы с зависимостями
```bash
# Пересборка образов
docker-compose build --no-cache
docker-compose up -d
```

## Мониторинг и отладка

### Логирование

#### Просмотр логов
```bash
# Логи приложения
docker-compose logs -f app

# Логи базы данных
docker-compose logs -f postgres

# Логи RabbitMQ
docker-compose logs -f rabbitmq
```

#### Уровни логирования
- `DEBUG` - детальная отладочная информация
- `INFO` - общая информация о работе
- `WARNING` - предупреждения
- `ERROR` - ошибки
- `CRITICAL` - критические ошибки

### Мониторинг производительности

#### Prometheus (опционально)
```bash
# Запуск с мониторингом
docker-compose --profile monitoring up -d
```

#### Доступ к метрикам
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000 (admin/admin123)

### Отладка

#### Подключение к контейнеру
```bash
# Подключение к приложению
docker-compose exec app bash

# Подключение к БД
docker-compose exec postgres psql -U postgres -d medical_db
```

#### Проверка состояния сервисов
```bash
# Статус контейнеров
docker-compose ps

# Использование ресурсов
docker stats

# Проверка сетей
docker network ls
```

### Тестирование

#### Запуск тестов
```bash
cd app
pytest                    # Все тесты
pytest --cov=.           # С покрытием
pytest -v                # Подробный вывод
```

#### Тестирование API
```bash
# Тестовая страница
http://localhost:80/test_integration.html
```

### Резервное копирование

#### База данных
```bash
# Создание бэкапа
docker-compose exec postgres pg_dump -U postgres medical_db > backup.sql

# Восстановление
docker-compose exec -T postgres psql -U postgres medical_db < backup.sql
```

#### Конфигурация
```bash
# Бэкап конфигурации
tar -czf config_backup.tar.gz .env docker-compose.yaml nginx/
```

## Заключение

MFDP представляет собой комплексную систему для управления медицинскими процессами с использованием современных технологий и подходов к разработке. Система обеспечивает:

- **Модульность**: Четкое разделение на компоненты
- **Масштабируемость**: Возможность горизонтального масштабирования
- **Надежность**: Обработка ошибок и мониторинг
- **Производительность**: Кэширование и асинхронная обработка
- **Безопасность**: Аутентификация и валидация данных

Система готова к использованию в производственной среде и может быть легко расширена новыми функциями и модулями. 