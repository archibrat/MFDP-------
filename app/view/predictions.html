{% extends "base.html" %}

{% block title %}ML –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è{% endblock %}

{% block head %}
{{ super() }}
<style>
.prediction-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.prediction-form {
    background: #f8f9fa;
    padding: 30px;
    border-radius: 10px;
    margin-bottom: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

.form-group input, .form-group select {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
}

.prediction-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 30px;
    border: none;
    border-radius: 5px;
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.2s;
}

.prediction-button:hover {
    transform: translateY(-2px);
}

.prediction-result {
    background: white;
    padding: 25px;
    border-radius: 10px;
    margin-top: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.risk-indicator {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    margin: 10px 0;
}

.risk-low { background: #d4edda; color: #155724; }
.risk-medium { background: #fff3cd; color: #856404; }
.risk-high { background: #f8d7da; color: #721c24; }

.recommendations {
    background: #e7f3ff;
    padding: 15px;
    border-radius: 5px;
    margin-top: 15px;
}

.recommendations ul {
    margin: 0;
    padding-left: 20px;
}

.batch-upload {
    background: #e8f5e8;
    padding: 20px;
    border-radius: 10px;
    margin-top: 30px;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #45a049);
    transition: width 0.5s ease;
}

.analytics-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 30px;
}

.metric-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
}

.metric-value {
    font-size: 2.5em;
    font-weight: bold;
    color: #667eea;
}

.metric-label {
    color: #666;
    margin-top: 10px;
}
</style>
<script src="https://unpkg.com/htmx.org@1.8.4"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="prediction-container">
    <h1>üîÆ ML –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —É—Å–ª—É–≥</h1>
    
    {% if user %}
    <!-- –§–æ—Ä–º–∞ –µ–¥–∏–Ω–∏—á–Ω–æ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è -->
    <div class="prediction-form">
        <h2>–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ä–∏—Å–∫–∞ –Ω–µ—è–≤–∫–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞</h2>
        <form hx-post="/api/predictions/predict" 
              hx-target="#prediction-result" 
              hx-swap="innerHTML"
              hx-indicator="#loading">
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="client_id">ID –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="text" name="client_id" id="client_id" required>
                </div>
                
                <div class="form-group">
                    <label for="booking_id">ID –∑–∞–ø–∏—Å–∏</label>
                    <input type="text" name="booking_id" id="booking_id" required>
                </div>
                
                <div class="form-group">
                    <label for="age">–í–æ–∑—Ä–∞—Å—Ç</label>
                    <input type="number" name="age" id="age" min="0" max="120" required>
                </div>
                
                <div class="form-group">
                    <label for="gender">–ü–æ–ª</label>
                    <select name="gender" id="gender" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                        <option value="m">–ú—É–∂—Å–∫–æ–π</option>
                        <option value="f">–ñ–µ–Ω—Å–∫–∏–π</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="district">–†–∞–π–æ–Ω</label>
                    <input type="text" name="district" id="district" required>
                </div>
                
                <div class="form-group">
                    <label for="scholarship">–õ—å–≥–æ—Ç–Ω–∏–∫</label>
                    <select name="scholarship" id="scholarship">
                        <option value="false">–ù–µ—Ç</option>
                        <option value="true">–î–∞</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="condition_a">–ì–∏–ø–µ—Ä—Ç–æ–Ω–∏—è</label>
                    <select name="condition_a" id="condition_a">
                        <option value="false">–ù–µ—Ç</option>
                        <option value="true">–î–∞</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="condition_b">–î–∏–∞–±–µ—Ç</label>
                    <select name="condition_b" id="condition_b">
                        <option value="false">–ù–µ—Ç</option>
                        <option value="true">–î–∞</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="condition_c">–ê–ª–∫–æ–≥–æ–ª–∏–∑–º</label>
                    <select name="condition_c" id="condition_c">
                        <option value="false">–ù–µ—Ç</option>
                        <option value="true">–î–∞</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="accessibility_level">–£—Ä–æ–≤–µ–Ω—å –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏</label>
                    <select name="accessibility_level" id="accessibility_level">
                        <option value="0">–ù–µ—Ç</option>
                        <option value="1">1 –≥—Ä—É–ø–ø–∞</option>
                        <option value="2">2 –≥—Ä—É–ø–ø–∞</option>
                        <option value="3">3 –≥—Ä—É–ø–ø–∞</option>
                        <option value="4">4 –≥—Ä—É–ø–ø–∞</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="notification_sent">SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</label>
                    <select name="notification_sent" id="notification_sent">
                        <option value="false">–ù–µ—Ç</option>
                        <option value="true">–î–∞</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="planned_date">–î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏</label>
                    <input type="datetime-local" name="planned_date" id="planned_date" required>
                </div>
                
                <div class="form-group">
                    <label for="session_date">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞</label>
                    <input type="datetime-local" name="session_date" id="session_date" required>
                </div>
                
                <div class="form-group">
                    <label for="include_explanation">–í–∫–ª—é—á–∏—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ</label>
                    <select name="include_explanation" id="include_explanation">
                        <option value="false">–ù–µ—Ç</option>
                        <option value="true">–î–∞</option>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="prediction-button">
                üöÄ –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
            </button>
            
            <div id="loading" class="htmx-indicator">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%; animation: pulse 1.5s infinite;"></div>
                </div>
                –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...
            </div>
        </form>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è -->
    <div id="prediction-result" class="prediction-result" style="display: none;">
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ HTMX -->
    </div>
    
    <!-- –ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ -->
    <div class="batch-upload">
        <h2>üìä –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</h2>
        <form hx-post="/api/predictions/predict/batch" 
              hx-target="#batch-result"
              hx-encoding="multipart/form-data">
            
            <div class="form-group">
                <label for="batch_file">–ó–∞–≥—Ä—É–∑–∏—Ç—å CSV —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</label>
                <input type="file" name="batch_file" id="batch_file" accept=".csv" required>
            </div>
            
            <button type="submit" class="prediction-button">
                üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–∫–µ—Ç
            </button>
        </form>
        
        <div id="batch-result"></div>
    </div>
    
    <!-- –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—à–±–æ—Ä–¥ -->
    <div class="analytics-dashboard">
        <div class="metric-card" hx-get="/api/predictions/analytics/performance" 
             hx-trigger="load, every 30s">
            <div class="metric-value" id="accuracy-metric">--</div>
            <div class="metric-label">–¢–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏</div>
        </div>
        
        <div class="metric-card" hx-get="/api/predictions/models/status" 
             hx-trigger="load, every 60s">
            <div class="metric-value" id="predictions-count">--</div>
            <div class="metric-label">–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value" id="model-version">v2.0</div>
            <div class="metric-label">–í–µ—Ä—Å–∏—è –º–æ–¥–µ–ª–∏</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value" id="response-time">--ms</div>
            <div class="metric-label">–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
        </div>
    </div>
    
    <!-- –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ -->
    <div style="margin-top: 30px; background: white; padding: 20px; border-radius: 10px;">
        <h3>üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏</h3>
        <canvas id="performanceChart" width="400" height="200"></canvas>
    </div>
    
    {% else %}
    <div class="prediction-form">
        <h2>üîí –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h2>
        <p>–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ML-—Ñ—É–Ω–∫—Ü–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ <a href="/auth/login">–≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a>.</p>
    </div>
    {% endif %}
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '–¢–æ—á–Ω–æ—Å—Ç—å',
                data: [],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4
            }, {
                label: 'F1-Score',
                data: [],
                borderColor: '#764ba2',
                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '–ú–µ—Ç—Ä–∏–∫–∏ –º–æ–¥–µ–ª–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1
                }
            }
        }
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    loadPerformanceData(chart);
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    setInterval(() => loadPerformanceData(chart), 300000);
});

async function loadPerformanceData(chart) {
    try {
        const response = await fetch('/api/predictions/analytics/performance?days=7');
        const data = await response.json();
        
        chart.data.labels = data.dates;
        chart.data.datasets[0].data = data.accuracy;
        chart.data.datasets[1].data = data.f1_score;
        chart.update();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
        document.getElementById('accuracy-metric').textContent = 
            (data.accuracy[data.accuracy.length - 1] * 100).toFixed(1) + '%';
            
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:', error);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.id === 'prediction-result') {
        document.getElementById('prediction-result').style.display = 'block';
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        event.detail.target.style.opacity = '0';
        event.detail.target.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            event.detail.target.style.transition = 'all 0.5s ease';
            event.detail.target.style.opacity = '1';
            event.detail.target.style.transform = 'translateY(0)';
        }, 100);
    }
});

// –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–º–∏
function fillDemoData() {
    document.getElementById('client_id').value = 'DEMO_001';
    document.getElementById('booking_id').value = 'BOOK_' + Date.now();
    document.getElementById('age').value = '45';
    document.getElementById('gender').value = 'f';
    document.getElementById('district').value = '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π';
    document.getElementById('condition_a').value = 'true';
    
    const now = new Date();
    const planDate = new Date(now.getTime() - 24 * 60 * 60 * 1000); // –≤—á–µ—Ä–∞
    const sessDate = new Date(now.getTime() + 24 * 60 * 60 * 1000); // –∑–∞–≤—Ç—Ä–∞
    
    document.getElementById('planned_date').value = planDate.toISOString().slice(0, 16);
    document.getElementById('session_date').value = sessDate.toISOString().slice(0, 16);
}

// –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö
window.addEventListener('load', function() {
    const form = document.querySelector('.prediction-form form');
    const demoButton = document.createElement('button');
    demoButton.type = 'button';
    demoButton.className = 'prediction-button';
    demoButton.style.background = '#28a745';
    demoButton.style.marginRight = '10px';
    demoButton.textContent = 'üéØ –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ';
    demoButton.onclick = fillDemoData;
    
    form.insertBefore(demoButton, form.querySelector('button[type="submit"]'));
});
</script>
{% endblock %}
